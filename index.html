<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Morning Check-In</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      text-align: center;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 20px;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 20px;
    }
    #result {
      font-size: 1.2em;
      font-weight: bold;
      color: #2ecc71; /* 亮绿色但可读 */
      min-height: 24px;
      margin-top: 10px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1 id="welcome">Good Morning!</h1>
  <div id="reader"></div>
  <div id="result"></div>

  <!-- 隐藏 iframe 用于提交表单（避免页面跳转） -->
  <iframe name="hiddenFrame" class="hidden"></iframe>

  <!-- 引入 html5-qrcode 库（CDN） -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    // 1. 从 URL 获取 user 参数
    const urlParams = new URLSearchParams(window.location.search);
    const userName = url_params.get('user') || 'Guest';

    // 显示欢迎语
    document.getElementById('welcome').textContent = `Good Morning, ${userName}!`;

    // 2. 初始化 QR 扫描器
    const qrCodeScanner = new Html5Qrcode("reader");
    const resultDiv = document.getElementById("result");

    qrCodeScanner.start(
      { facingMode: "environment" }, // 使用后置摄像头
      {
        fps: 10,
        qrbox: { width: 250, height: 250 },
      },
      (decodedText) => {
        // 成功扫描
        if (decodedText === "MORNING-CHECKIN-VERIFIED-2024") {
          resultDiv.textContent = "Successfully Checked In.";
          
          // 提交到 GAS
          const form = document.createElement("form");
          form.method = "POST";
          form.action = "https://script.google.com/macros/s/AKfycbwXZ6yYJvUjVwqJx9iDnFzRrTmQeVdZzZzZzZzZzZzZzZzZzZ/exec"; // 替换为你的 Web App URL
          form.target = "hiddenFrame";

          const nameInput = document.createElement("input");
          nameInput.type = "hidden";
          nameInput.name = "name";
          nameInput.value = userName;

          const timestampInput = document.createElement("input");
          timestampInput.type = "hidden";
          timestampInput.name = "timestamp";
          timestampInput.value = new Date().toISOString();

          form.appendChild(nameInput);
          form.appendChild(timestampInput);
          document.body.appendChild(form);
          form.submit();

          // 停止扫描
          qrCodeScanner.stop().catch(err => console.log("Stop error:", err));
        } else {
          resultDiv.textContent = "Invalid QR Code!";
          resultDiv.style.color = "#e74c3c";
        }
      },
      (errorMessage) => {
        // 扫描错误（通常可忽略）
      }
    ).catch(err => {
      console.error("QR Scanner init failed:", err);
      resultDiv.textContent = "Camera access denied or not supported.";
      resultDiv.style.color = "#e74c3c";
    });
  </script>
</body>
</html>
