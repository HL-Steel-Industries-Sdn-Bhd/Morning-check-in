<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Morning Check-In</title>

<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f0f2f5;
        text-align: center;
    }

    #greeting {
        margin-top: 18px;
        font-size: 1.4em;
        font-weight: bold;
    }

    #video {
        width: 95vw;
        max-width: 450px;
        margin-top: 15px;
        border-radius: 12px;
        background: #000;
    }

    #successMsg {
        margin-top: 20px;
        font-size: 1.3em;
        font-weight: bold;
        color: #1db954;
        display: none;
    }
</style>
</head>
<body>

<h2 id="greeting">Good morning!</h2>

<video id="video"></video>

<p id="successMsg">Successfully Checked In.</p>

<iframe name="hiddenFrame" style="display:none;"></iframe>
<form id="submitForm" method="POST" target="hiddenFrame"></form>

<script>
// Get user from URL
const username = new URLSearchParams(location.search).get("user") || "Guest";
document.getElementById("greeting").textContent = `Good morning, ${username}!`;

const GAS_URL = "YOUR_GAS_DEPLOYED_WEBAPP_URL";
const TARGET_TEXT = "CHECK IN RECORD FOR YEAR 2025";

const codeReader = new ZXingBrowser.BrowserQRCodeReader();

async function startCamera() {
    try {
        const videoElem = document.getElementById('video');

        const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
        let backCam = devices.find(d => /back|rear|environment/i.test(d.label));

        if (!backCam) backCam = devices[0]; // fallback

        codeReader.decodeFromVideoDevice(backCam.deviceId, 'video', (result, err) => {
            if (result) {
                const text = result.text.trim();
                if (text === TARGET_TEXT) {
                    document.getElementById("successMsg").style.display = "block";
                    
                    const now = new Date().toISOString();
                    const form = document.getElementById("submitForm");

                    form.innerHTML = `
                        <input type="hidden" name="name" value="${username}">
                        <input type="hidden" name="timestamp" value="${now}">
                    `;
                    form.action = GAS_URL;
                    form.submit();

                    codeReader.reset(); // stop camera
                }
            }
        });

    } catch (e) {
        alert("Camera access failed: " + e.message);
    }
}

startCamera();
</script>

</body>
</html>
